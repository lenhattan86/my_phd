\section{Background and prior work}
Internet-scale services, such as  Google's search services, Akamai's content delivery services, and Amazon's cloud computing services are rapidly growing, consume large amounts of energy \cite{koomey2011growth}. In fact, energy costs account for a large portion of the overall operating expenditure of such services.  The two main approaches for reducing the energy cost are, to procure energy in a more cost effective manner, and to reduce the total energy consumption. While there has been much work on both approaches, we provide a survey of the energy procurement literature below.


%Both the consumers at demand side \cite{philpott2006optimizing, dicorato2009risk} and suppliers can participate in the forward markets \cite{wen2001strategic, nair2014energy} by bidding their energy demand/supply under some risk constraints \cite{garcia2007risk, siddiqui2003managing}.

A key technique used to reduce energy costs is to exploit the {\em temporal} variation of energy prices and shift the delay-tolerant workload, such as batch jobs, to off-peak time periods when the electricity prices are lower \cite{gandhi2011minimizing, lin2013dynamic, meisner2011power, zhang2012dynamic}. An alternate technique is to ``move the energy'' using a battery. By charging the batteries from the grid when the electricity prices are lower and discharging it when prices are higher,  the overall energy costs can be reduced \cite{urgaonkar2011optimal, liu2013data}. Since service providers pay for the peak of electricity usage, batteries can also be used to ``shave'' the power peaks to reduce the energy costs \cite{palasamudram2012using}. The above papers all consider a single data center. In contrast, the  approach in this paper is applicable to cloud providers with multiple, geographically distributed, data centers.

Another complementary technique that is relevant to service providers with multiple geo-distributed data centers is to exploit the {\em geographical} variation in energy prices. There has been much work in geographical load balancing (GLB) algorithms that route the workload to the regional markets with cheap electricity prices to reduce the total energy cost \cite{qureshi2009cutting,liu2011greening}. While these works rely on the spatial diversity of electricity prices in real-time, our approach deal with the uncertainty of electricity prices in forward markets.

In addition, data centers can reduce the energy cost by utilizing onsite renewable generation. Although the output of renewable energy sources is intermittent, a single data center can schedule its delay-tolerant workloads to adapt to the renewable generation \cite{liu2012renewable}. Service providers with geographically distributed data centers can even do better by shifting their workload to the data centers that have available renewable sources \cite{chen2012green, liu2011greening,gupta2016cool}. Thus, the amount of energy cost reductions heavily depends on the percentage of delay-tolerant workloads and the penetration of renewable energy. 

%Besides the electricity costs, GLB also takes into account different objectives such as carbon footprint, performance guarantees, renewable energy usage, and cooling energy requirements \cite{rahman2014survey}. The temporal and spatial variabilities of electricity prices in smart grids are analyzed to build an optimizer that can achieve economic gain by considering the data center network's constraints \cite{qureshi2009cutting, chiaraviglio2011energy}. Greening GLB was proposed to encourage the use of green renewable energy and reduce brown energy consumption \cite{liu2011greening}. Considering data centers as price makers, the idea of capping electricity cost was introduced to prevent monthly costs from exceeding the desired budget \cite{zhang2011capping}. Energy storage is also used with GLB to minimize the electricity cost \cite{guo2011cutting}. Lyapunov optimization framework was used to propose a control algorithm to reduce the power cost of delay-tolerant workloads in an online manner \cite{yao2012data}. %We emphasize that in all these works, the geographical load balancing is only applicable to real-time markets, and not to multi-timescale markets that are the focus of our work.

Participating in multiple time-scale markets, i.e., in both forward electricity markets and spot markets, has not been explored in-depth in prior work, and it can be a promising approach to more effectively reduce the energy cost. The forward electricity markets, such as long-term (several months) and short-term (day-ahead), were designed to improve the traditional electricity markets, which have only spot (real-time) markets \cite{ausubel2010using}. Forward electricity markets have already been adopted in some parts of the US such as New England \cite{cramton2007colombia}. Forward markets can benefit both customers and utility suppliers. For example, the forward markets allow suppliers and consumers to agree on a fixed price several months ahead of when the electricity is produced and consumed. This allows the supplier to plan ahead and ensure the availability of energy for its customers. The forward markets usually provide cheaper prices than the spot markets. 
There are a few recent papers on data centers that consider forward markets; these papers deal with the financial risk arising from the uncertainties in electricity prices and workload \cite{rao2011hedging,yu2012risk}. 
Geographical load balancing systems with both day-head market and real-time markets has been studied in a recent publication~\cite{ghamkhari2016energy}. However, the proposed solution is somewhat restrictive to particular distributions to facilitate stochastic optimization and does not provide any optimality guarantee.
%{\em However, to the best of our knowledge, our work is the first to study how an Internet-scale distributed service with geo-distributed data centers can optimally procure electricity in multi-timescale markets.}
%The initial work in this space minimizes the variance of the electricity cost by observing historical workload and electricity prices \cite{rao2011hedging}. Meanwhile, operation risk due to uncertainties of electricity prices and workload is also considered with an additional assumption \cite{yu2012risk, yu2013risk} that workload and electricity price may be not probabilistically independent. An operation-risk aware power procurement algorithm was introduced for a single data center to participate in day-ahead and real-time electricity markets while considering the uncertainties of electricity prices and workload using the stochastic optimization framework \cite{ghamkhari2014optimal}. 

% Electricity customers in multiple electricity markets \cite{wang2014optimization}.

%\desc{The potentials of data centers participating in long-term markets.}

%In practice, data center operators generally purchase electricity between 30 to 90 days ahead \cite{datacenerknowledge2015DataCenter}. Major cloud computing providers purchase renewable energy with longer term contracts. For example, Google invests in 20-year contracts for buying renewable energy from generators \cite{google2015datacenter}. Also, Apple and HP buy huge amounts of energy generated from wind farms ahead of time for their data centers \cite{datacenerknowledge2015HP, datacenerknowledge2015Amazon}. Purchasing energy ahead of time requires data center operators to have a precise procurement plan since the future workload, renewable energy generation, and electricity prices are all uncertain. Hence, we believe that having optimal energy procurement algorithms  for long-term markets, such as those provided in our work, is crucial for Internet service providers who operate multiple data centers. 
